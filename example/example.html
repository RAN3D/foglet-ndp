<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>3 Clients tests</title>
    <script type='text/javascript' src='../node_modules/jquery/dist/jquery.min.js'> </script>
    <script type='text/javascript' src='../build/foglet-ndp.bundle.js' > </script>
    <script type='text/javascript' src='../node_modules/chart.js/dist/Chart.js'></script>
  </head>

  <script type='text/javascript'>
    localStorage.debug = '*ladda*';

    const NDP = require('foglet-ndp').NDP;

    let request = [
    	"PREFIX dbp: <http://dbpedia.org/resource/Jos%C3%A9_Amaya> \t\t\t   PREFIX dbp2: <http://dbpedia.org/ontology/> \t\t\t  \t\t\t   SELECT ?abstract \t\t\t   WHERE { \t\t\t\t  dbp:  \t\t\t\t  dbp2:abstract ?abstract .  \t\t\t\t  FILTER langMatches(lang(?abstract), 'en') \t\t\t   }\n",
    	"PREFIX foaf: <http://xmlns.com/foaf/0.1/> PREFIX geo: <http://www.w3.org/2003/01/geo/wgs84_pos#> PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#> SELECT * WHERE { {?city rdfs:label 'El Badari'@en.} UNION { ?alias <http://dbpedia.org/property/redirect> ?city;  rdfs:label 'El Badari'@en. } UNION { ?alias <http://dbpedia.org/property/disambiguates> ?city;  rdfs:label 'El Badari'@en. } OPTIONAL { ?city <http://dbpedia.org/ontology/abstract> ?abstract} OPTIONAL { ?city geo:lat ?latitude; geo:long ?longitude}OPTIONAL { ?city foaf:depiction ?image } OPTIONAL { ?city rdfs:label ?name } OPTIONAL { ?city foaf:homepage ?home } OPTIONAL { ?city <http://dbpedia.org/ontology/populationTotal> ?population } OPTIONAL { ?city <http://dbpedia.org/ontology/thumbnail> ?thumbnail } FILTER (langMatches( lang(?abstract), 'en'))}\n",
    	"PREFIX foaf: <http://xmlns.com/foaf/0.1/> PREFIX geo: <http://www.w3.org/2003/01/geo/wgs84_pos#> PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#> SELECT * WHERE { {?city rdfs:label 'Alghisi'@en.} UNION { ?alias <http://dbpedia.org/property/redirect> ?city;  rdfs:label 'Alghisi'@en. } UNION { ?alias <http://dbpedia.org/property/disambiguates> ?city;  rdfs:label 'Alghisi'@en. } OPTIONAL { ?city <http://dbpedia.org/ontology/abstract> ?abstract} OPTIONAL { ?city geo:lat ?latitude; geo:long ?longitude}OPTIONAL { ?city foaf:depiction ?image } OPTIONAL { ?city rdfs:label ?name } OPTIONAL { ?city foaf:homepage ?home } OPTIONAL { ?city <http://dbpedia.org/ontology/populationTotal> ?population } OPTIONAL { ?city <http://dbpedia.org/ontology/thumbnail> ?thumbnail } FILTER (langMatches( lang(?abstract), 'en'))}\n",
    	"PREFIX foaf: <http://xmlns.com/foaf/0.1/> PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#> SELECT * WHERE { ?city a <http://dbpedia.org/ontology/Place>; rdfs:label 'Lužnice'@en.  ?airport a <http://dbpedia.org/ontology/Airport>. {?airport <http://dbpedia.org/ontology/city> ?city} UNION {?airport <http://dbpedia.org/ontology/location> ?city} UNION {?airport <http://dbpedia.org/property/cityServed> ?city.} UNION {?airport <http://dbpedia.org/ontology/city> ?city. }{?airport <http://dbpedia.org/property/iata> ?iata.} UNION  {?airport <http://dbpedia.org/ontology/iataLocationIdentifier> ?iata. } OPTIONAL { ?airport foaf:homepage ?airport_home. } OPTIONAL { ?airport rdfs:label ?name. } OPTIONAL { ?airport <http://dbpedia.org/property/nativename> ?airport_name.} FILTER ( !bound(?name) || langMatches( lang(?name), 'en') )}\n",
    	"PREFIX foaf: <http://xmlns.com/foaf/0.1/> PREFIX geo: <http://www.w3.org/2003/01/geo/wgs84_pos#> PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#> SELECT * WHERE { {?city rdfs:label 'Lužnice'@en.} UNION { ?alias <http://dbpedia.org/property/redirect> ?city;  rdfs:label 'Lužnice'@en. } UNION { ?alias <http://dbpedia.org/property/disambiguates> ?city;  rdfs:label 'Lužnice'@en. } OPTIONAL { ?city <http://dbpedia.org/ontology/abstract> ?abstract} OPTIONAL { ?city geo:lat ?latitude; geo:long ?longitude}OPTIONAL { ?city foaf:depiction ?image } OPTIONAL { ?city rdfs:label ?name } OPTIONAL { ?city foaf:homepage ?home } OPTIONAL { ?city <http://dbpedia.org/ontology/populationTotal> ?population } OPTIONAL { ?city <http://dbpedia.org/ontology/thumbnail> ?thumbnail } FILTER (langMatches( lang(?abstract), 'en'))}\n",
    	"PREFIX foaf: <http://xmlns.com/foaf/0.1/> PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#> SELECT * WHERE {  ?airport a <http://dbpedia.org/ontology/Airport>; rdfs:label ?name. {?airport <http://dbpedia.org/property/iata> 'LNZ'@en.} UNION  {?airport <http://dbpedia.org/ontology/iataLocationIdentifier> 'LNZ'@en. } OPTIONAL { ?airport foaf:homepage ?airport_home. } OPTIONAL { ?airport rdfs:label ?name. } OPTIONAL { ?airport <http://dbpedia.org/property/nativename> ?airport_name.} FILTER ( !bound(?name) || langMatches( lang(?name), 'en') )}\n",
    	"PREFIX foaf: <http://xmlns.com/foaf/0.1/> PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#> SELECT * WHERE { ?city a <http://dbpedia.org/ontology/Place>; rdfs:label 'Rožmberk nad Vltavou'@en.  ?airport a <http://dbpedia.org/ontology/Airport>. {?airport <http://dbpedia.org/ontology/city> ?city} UNION {?airport <http://dbpedia.org/ontology/location> ?city} UNION {?airport <http://dbpedia.org/property/cityServed> ?city.} UNION {?airport <http://dbpedia.org/ontology/city> ?city. }{?airport <http://dbpedia.org/property/iata> ?iata.} UNION  {?airport <http://dbpedia.org/ontology/iataLocationIdentifier> ?iata. } OPTIONAL { ?airport foaf:homepage ?airport_home. } OPTIONAL { ?airport rdfs:label ?name. } OPTIONAL { ?airport <http://dbpedia.org/property/nativename> ?airport_name.} FILTER ( !bound(?name) || langMatches( lang(?name), 'en') )}\n",
    	"PREFIX foaf: <http://xmlns.com/foaf/0.1/> PREFIX geo: <http://www.w3.org/2003/01/geo/wgs84_pos#> PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#> SELECT * WHERE { {?city rdfs:label 'Rožmberk nad Vltavou'@en.} UNION { ?alias <http://dbpedia.org/property/redirect> ?city;  rdfs:label 'Rožmberk nad Vltavou'@en. } UNION { ?alias <http://dbpedia.org/property/disambiguates> ?city;  rdfs:label 'Rožmberk nad Vltavou'@en. } OPTIONAL { ?city <http://dbpedia.org/ontology/abstract> ?abstract} OPTIONAL { ?city geo:lat ?latitude; geo:long ?longitude}OPTIONAL { ?city foaf:depiction ?image } OPTIONAL { ?city rdfs:label ?name } OPTIONAL { ?city foaf:homepage ?home } OPTIONAL { ?city <http://dbpedia.org/ontology/populationTotal> ?population } OPTIONAL { ?city <http://dbpedia.org/ontology/thumbnail> ?thumbnail } FILTER (langMatches( lang(?abstract), 'en'))}\n"    	
    ];



    let f1,f2,f3;

    let verbose = false;

    f1 = new NDP({
      protocol: 'testNdp',
      webrtc:	{
        trickle: true,
        iceServers : []
      },
      room: 'test',
      verbose: verbose,
      enableFanoutBroadcast: false
    });
    f2 = new NDP({
      protocol: 'testNdp',
      webrtc:	{
        trickle: true,
        iceServers : []
      },
      room: 'test',
      verbose: verbose,
      enableFanoutBroadcast: false
    });

    f3 = new NDP({
      protocol: 'testNdp',
      webrtc:	{
        trickle: true,
        iceServers : []
      },
      room: 'test',
      verbose: verbose,
      enableFanoutBroadcast: false
    });

    f1.init();
    f2.init();
    f3.init();


    f1.connection().then(() => {
      f2.connection().then(() => {
        f3.connection().then( () => {
          f1.delegationProtocol.timeout = 10*1000;
          let data = f1.delegationProtocol.fanout.estimator.data;

          let ctx = document.getElementById("chart");
          let chart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: [],
              datasets: [{
                  id: null,
                  label: 'Original Data',
                  fill: false,
                  lineTension: 0.1,
                  backgroundColor: "rgba(75,192,192,0.4)",
                  borderColor: "rgba(75,192,192,1)",
                  borderCapStyle: 'butt',
                  borderDash: [],
                  borderDashOffset: 0.0,
                  borderJoinStyle: 'miter',
                  pointBorderColor: "rgba(75,192,192,1)",
                  pointBackgroundColor: "#fff",
                  pointBorderWidth: 1,
                  pointHoverRadius: 5,
                  pointHoverBackgroundColor: "rgba(75,192,192,1)",
                  pointHoverBorderColor: "rgba(220,220,220,1)",
                  pointHoverBorderWidth: 2,
                  pointRadius: 1,
                  pointHitRadius: 10,
                  data: [],
                  spanGaps: false,
              },
              {
                  id: null,
                  label: 'Regression',
                  fill: false,
                  lineTension: 0.1,
                  backgroundColor: "rgba(239,46,46,0.4)",
                  borderColor: "rgba(239,46,46,1)",
                  borderCapStyle: 'butt',
                  borderDash: [],
                  borderDashOffset: 0.0,
                  borderJoinStyle: 'miter',
                  pointBorderColor: "rgba(239,46,46,1)",
                  pointBackgroundColor: "#fff",
                  pointBorderWidth: 1,
                  pointHoverRadius: 5,
                  pointHoverBackgroundColor: "rgba(239,46,46,1)",
                  pointHoverBorderColor: "rgba(239,46,46,1)",
                  pointHoverBorderWidth: 2,
                  pointRadius: 1,
                  pointHitRadius: 10,
                  data: [],
                  spanGaps: false,
              }]
            },
            options: {
              responsive: true,
              scales: {
                xAxes: [{
                    type: 'linear',
                    position: 'bottom'
                }],
                yAxes: [{
                    ticks: {
                      stacked: true,
                      beginAtZero:true
                    }
                }]
              }
            }
          });
          for(let i=0; i<data.x.length; ++i){
            // console.log({ x: data.x[i], y:data.y[i] }, { x: data.x[i], y:f1.delegationProtocol.fanout.estimator.f(data.x[i]) });
            chart.data.datasets[0].data.push({ x: data.x[i], y:data.y[i] });
            chart.data.datasets[1].data.push({ x: data.x[i], y:f1.delegationProtocol.fanout.estimator.f(data.x[i]) });
          }

          chart.update();
        });
      });
    });

    f1.delegationProtocol.on('ndp-fanout-changed', (y, fanout, neighbours, delegationQueries) => {
      console.log('Listen : ', y, fanout, neighbours, delegationQueries);
    });

    // f1.onUnicast((id, message) => console.log('Fanout: ', f3.delegationProtocol.nbDestinations, f2.delegationProtocol.nbDestinations,f1.delegationProtocol.nbDestinations));
    // f2.onUnicast((id, message) => console.log('Fanout: ', f3.delegationProtocol.nbDestinations, f2.delegationProtocol.nbDestinations,f1.delegationProtocol.nbDestinations));
    // f3.onUnicast((id, message) => console.log('Fanout: ', f3.delegationProtocol.nbDestinations, f2.delegationProtocol.nbDestinations,f1.delegationProtocol.nbDestinations));

    function load(endpoint = 'http://fragments.mementodepot.org/dbpedia_3_8') {
      f1.delegationProtocol.sendPromise(request, endpoint, false, 2000, 5, 500).then(r => {
        console.log(r);
      });
    }


  </script>

  <body>
    <h3> Please see your console (F12) to see logs of the example </h3>
    <p> If an error appeared with jquery, it's because you did not clone the repository from github, you just installed the package with npm.
      <br/> JQuery is not in the dependencies installed. Idem for chart.js</p>

      <canvas id="chart" width="400" height="200"></canvas>
  </body>

</html>

<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>3 Clients tests</title>
    <script type='text/javascript' src='../dist/foglet-ndp.bundle.js' > </script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  </head>

  <script type='text/javascript'>
    localStorage.debug = 'foglet-*,HttpClient';
    console.log(foglet);
    const NDP = foglet.NDP;
    let endpoint = 'http://172.16.9.3:5000/dbpedia_3_8';
    // endpoint = 'http://172.16.8.50:5000/dbpedia_3_8';
    let request = [
      "PREFIX dbp: <http://dbpedia.org/resource/Jos%C3%A9_Amaya> \t\t\t   PREFIX dbp2: <http://dbpedia.org/ontology/> \t\t\t  \t\t\t   SELECT ?abstract \t\t\t   WHERE { \t\t\t\t  dbp:  \t\t\t\t  dbp2:abstract ?abstract .  \t\t\t\t  FILTER langMatches(lang(?abstract), 'en') \t\t\t   }\n",
    	"PREFIX foaf: <http://xmlns.com/foaf/0.1/> PREFIX geo: <http://www.w3.org/2003/01/geo/wgs84_pos#> PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#> SELECT * WHERE { {?city rdfs:label 'El Badari'@en.} UNION { ?alias <http://dbpedia.org/property/redirect> ?city;  rdfs:label 'El Badari'@en. } UNION { ?alias <http://dbpedia.org/property/disambiguates> ?city;  rdfs:label 'El Badari'@en. } OPTIONAL { ?city <http://dbpedia.org/ontology/abstract> ?abstract} OPTIONAL { ?city geo:lat ?latitude; geo:long ?longitude}OPTIONAL { ?city foaf:depiction ?image } OPTIONAL { ?city rdfs:label ?name } OPTIONAL { ?city foaf:homepage ?home } OPTIONAL { ?city <http://dbpedia.org/ontology/populationTotal> ?population } OPTIONAL { ?city <http://dbpedia.org/ontology/thumbnail> ?thumbnail } FILTER (langMatches( lang(?abstract), 'en'))}\n",
    	"PREFIX foaf: <http://xmlns.com/foaf/0.1/> PREFIX geo: <http://www.w3.org/2003/01/geo/wgs84_pos#> PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#> SELECT * WHERE { {?city rdfs:label 'Alghisi'@en.} UNION { ?alias <http://dbpedia.org/property/redirect> ?city;  rdfs:label 'Alghisi'@en. } UNION { ?alias <http://dbpedia.org/property/disambiguates> ?city;  rdfs:label 'Alghisi'@en. } OPTIONAL { ?city <http://dbpedia.org/ontology/abstract> ?abstract} OPTIONAL { ?city geo:lat ?latitude; geo:long ?longitude}OPTIONAL { ?city foaf:depiction ?image } OPTIONAL { ?city rdfs:label ?name } OPTIONAL { ?city foaf:homepage ?home } OPTIONAL { ?city <http://dbpedia.org/ontology/populationTotal> ?population } OPTIONAL { ?city <http://dbpedia.org/ontology/thumbnail> ?thumbnail } FILTER (langMatches( lang(?abstract), 'en'))}\n",
    	"PREFIX foaf: <http://xmlns.com/foaf/0.1/> PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#> SELECT * WHERE { ?city a <http://dbpedia.org/ontology/Place>; rdfs:label 'Lužnice'@en.  ?airport a <http://dbpedia.org/ontology/Airport>. {?airport <http://dbpedia.org/ontology/city> ?city} UNION {?airport <http://dbpedia.org/ontology/location> ?city} UNION {?airport <http://dbpedia.org/property/cityServed> ?city.} UNION {?airport <http://dbpedia.org/ontology/city> ?city. }{?airport <http://dbpedia.org/property/iata> ?iata.} UNION  {?airport <http://dbpedia.org/ontology/iataLocationIdentifier> ?iata. } OPTIONAL { ?airport foaf:homepage ?airport_home. } OPTIONAL { ?airport rdfs:label ?name. } OPTIONAL { ?airport <http://dbpedia.org/property/nativename> ?airport_name.} FILTER ( !bound(?name) || langMatches( lang(?name), 'en') )}\n",
    	"PREFIX foaf: <http://xmlns.com/foaf/0.1/> PREFIX geo: <http://www.w3.org/2003/01/geo/wgs84_pos#> PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#> SELECT * WHERE { {?city rdfs:label 'Lužnice'@en.} UNION { ?alias <http://dbpedia.org/property/redirect> ?city;  rdfs:label 'Lužnice'@en. } UNION { ?alias <http://dbpedia.org/property/disambiguates> ?city;  rdfs:label 'Lužnice'@en. } OPTIONAL { ?city <http://dbpedia.org/ontology/abstract> ?abstract} OPTIONAL { ?city geo:lat ?latitude; geo:long ?longitude}OPTIONAL { ?city foaf:depiction ?image } OPTIONAL { ?city rdfs:label ?name } OPTIONAL { ?city foaf:homepage ?home } OPTIONAL { ?city <http://dbpedia.org/ontology/populationTotal> ?population } OPTIONAL { ?city <http://dbpedia.org/ontology/thumbnail> ?thumbnail } FILTER (langMatches( lang(?abstract), 'en'))}\n",
    	"PREFIX foaf: <http://xmlns.com/foaf/0.1/> PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#> SELECT * WHERE {  ?airport a <http://dbpedia.org/ontology/Airport>; rdfs:label ?name. {?airport <http://dbpedia.org/property/iata> 'LNZ'@en.} UNION  {?airport <http://dbpedia.org/ontology/iataLocationIdentifier> 'LNZ'@en. } OPTIONAL { ?airport foaf:homepage ?airport_home. } OPTIONAL { ?airport rdfs:label ?name. } OPTIONAL { ?airport <http://dbpedia.org/property/nativename> ?airport_name.} FILTER ( !bound(?name) || langMatches( lang(?name), 'en') )}\n",
    	"PREFIX foaf: <http://xmlns.com/foaf/0.1/> PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#> SELECT * WHERE { ?city a <http://dbpedia.org/ontology/Place>; rdfs:label 'Rožmberk nad Vltavou'@en.  ?airport a <http://dbpedia.org/ontology/Airport>. {?airport <http://dbpedia.org/ontology/city> ?city} UNION {?airport <http://dbpedia.org/ontology/location> ?city} UNION {?airport <http://dbpedia.org/property/cityServed> ?city.} UNION {?airport <http://dbpedia.org/ontology/city> ?city. }{?airport <http://dbpedia.org/property/iata> ?iata.} UNION  {?airport <http://dbpedia.org/ontology/iataLocationIdentifier> ?iata. } OPTIONAL { ?airport foaf:homepage ?airport_home. } OPTIONAL { ?airport rdfs:label ?name. } OPTIONAL { ?airport <http://dbpedia.org/property/nativename> ?airport_name.} FILTER ( !bound(?name) || langMatches( lang(?name), 'en') )}\n",
    	"PREFIX foaf: <http://xmlns.com/foaf/0.1/> PREFIX geo: <http://www.w3.org/2003/01/geo/wgs84_pos#> PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#> SELECT * WHERE { {?city rdfs:label 'Rožmberk nad Vltavou'@en.} UNION { ?alias <http://dbpedia.org/property/redirect> ?city;  rdfs:label 'Rožmberk nad Vltavou'@en. } UNION { ?alias <http://dbpedia.org/property/disambiguates> ?city;  rdfs:label 'Rožmberk nad Vltavou'@en. } OPTIONAL { ?city <http://dbpedia.org/ontology/abstract> ?abstract} OPTIONAL { ?city geo:lat ?latitude; geo:long ?longitude}OPTIONAL { ?city foaf:depiction ?image } OPTIONAL { ?city rdfs:label ?name } OPTIONAL { ?city foaf:homepage ?home } OPTIONAL { ?city <http://dbpedia.org/ontology/populationTotal> ?population } OPTIONAL { ?city <http://dbpedia.org/ontology/thumbnail> ?thumbnail } FILTER (langMatches( lang(?abstract), 'en'))}\n"
    ];



    let f1,f2,f3;
    let mean1 = data(), mean2 = data(), mean3 = data();

    function data () {
      return {
        mean: {
          x: [],
          y: [],
          add: function(val) {
            console.log(this);
            this.y.push(val);
            this.x.push(this.y.length);
          }
        },
        ecartType: {
          x: [],
          y: [],
          add: function(val) {
            this.y.push(val);
            this.x.push(this.y.length);
          }
        },
        meanReg: {
          x: [],
          y: [],
          add: function(val) {
            this.y.push(val);
            this.x.push(this.y.length);
          }
        },
        ecartTypeReg: {
          x: [],
          y: [],
          add: function(val) {
            this.y.push(val);
            this.x.push(this.y.length);
          }
        }
      };
    }

    let options = {
      nbDestinations: 50,
      verbose: true, // want some logs ? switch to false otherwise
      rps: {
        type: 'spray-wrtc',
        options: {
          protocol: 'ladda-estimator-test', // foglet running on the protocol foglet-example, defined for spray-wrtc
          webrtc:	{ // add WebRTC options
            trickle: true, // enable trickle (divide offers in multiple small offers sent by pieces)
            iceServers : [] // define iceServers in non local instance
          },
          timeout: 2 * 60 * 1000, // spray-wrtc timeout before definitively close a WebRTC connection.
          delta: 2* 60 * 1000, // spray-wrtc shuffle interval
          signaling: {
            address: 'http://localhost:3000/',
            // signalingAdress: 'https://signaling.herokuapp.com/', // address of the signaling server
            room: 'ladda-estimator-test' // room to join
          }
        }
      }
    };

    let verbose = true;

    f1 = new NDP(options);
    f2 = new NDP(options);
    f3 = new NDP(options);

    // initialized signaling sharing
    f1.share();
    f2.share();
    f3.share();
    // init each system delegated protocol
    f1.init();
    f2.init();
    f3.init();

    f1.delegationProtocol.timeout = 10*1000;
    f1.delegationProtocol.client.estimator.options.enable = false;
    f1.delegationProtocol.nbDestinations.value = 50;
    // f1.delegationProtocol.nbDestinations.value = 2;
    console.log('NbDestinations: ', f1.delegationProtocol.nbDestinations.value);
    console.log('Ldf Client estimator enabled: ', f1.delegationProtocol.client.estimator.options.enable);
    // connection of each peer
    f1.connection().then(() => {
      f2.connection().then(() => {
        f3.connection().then( () => {
          query(5);
        }).catch(e => console.log('F3->F1:', e));
      }).catch(e => console.log('F2->F3:',e));
    }).catch(e => console.log('F1->F2:',e));

    // listening on message
    f1.onUnicast((id, message) => console.log);
    f2.onUnicast((id, message) => console.log);
    f3.onUnicast((id, message) => console.log);

    f1.delegationProtocol.client.on('statistics', (items) => {
      mean1.mean.add(items.mean());
      mean1.ecartType.add(Math.sqrt(items.variance()));
      let coef = f1.delegationProtocol.client.estimator.getMeanLinearRegression();
      const yVal = coef.equation[0] * mean1.meanReg.x.length + coef.equation[1];
      mean1.meanReg.add(yVal);

      coef = f1.delegationProtocol.client.estimator.getEcartTypeLinearRegression();
      mean1.ecartTypeReg.add(coef.equation[0]*mean1.ecartTypeReg.x.length + coef.equation[1]);
    });

    f2.delegationProtocol.client.on('statistics', (items) => {
      mean2.mean.add(items.mean());
      mean2.ecartType.add(Math.sqrt(items.variance()));

      let coef = f2.delegationProtocol.client.estimator.getMeanLinearRegression();
      mean2.meanReg.add(coef.equation[0]*mean2.meanReg.x.length + coef.equation[1]);

      coef = f2.delegationProtocol.client.estimator.getEcartTypeLinearRegression();
      mean2.ecartTypeReg.add(coef.equation[0]*mean2.ecartTypeReg.x.length + coef.equation[1]);
    });

    f3.delegationProtocol.client.on('statistics', (items) => {
      mean3.mean.add(items.mean());
      mean3.ecartType.add(Math.sqrt(items.variance()));

      let coef = f3.delegationProtocol.client.estimator.getMeanLinearRegression();
      mean3.meanReg.add(coef.equation[0]*mean3.meanReg.x.length + coef.equation[1]);

      coef = f3.delegationProtocol.client.estimator.getEcartTypeLinearRegression();
      mean3.ecartTypeReg.add(coef.equation[0]*mean3.ecartTypeReg.x.length + coef.equation[1]);
    });

    function query(number) {
      console.log('All clients connected between them.')
      let a = 0, i = 0;
      let list = [];
      for(i = 0; i<number; ++i) list.push(i);

      list.reduce(elem => elem.then((results) => {
        a++;
        console.log('Results: '+a, results);
        return f1.delegationProtocol.sendPromise(request, endpoint, true);
      }), Promise.resolve(undefined)).then(() => {
        createPrePlot(f1.delegationProtocol.client.estimator.items, 'httpTime1', `Foglet1: Http response Time per request over the time on ${number} round(s)`)
        createPrePlot(f2.delegationProtocol.client.estimator.items, 'httpTime2', `Foglet2: Http response Time per request over the time on ${number} round(s)`)
        createPrePlot(f3.delegationProtocol.client.estimator.items, 'httpTime3', `Foglet3: Http response Time per request over the time on ${number} round(s)`)
        individualPlot(mean1, 'httpTimeMean1', 'Foglet1: HttpResponseTimeMean', 'Mean');
        individualPlot(mean2, 'httpTimeMean2', 'Foglet2: HttpResponseTimeMean', 'Mean');
        individualPlot(mean3, 'httpTimeMean3', 'Foglet3: HttpResponseTimeMean', 'Mean');


      }).catch(e => {
        console.error(e)
      });
    }

    function createPrePlot(items, name, title) {
      const values = items.values();
      console.log(values);
      const points = {
        y: values,
        x: Array.from(new Array(values.length), (x,i) => i+1),
        mean: Array.from(new Array(values.length), (x,i) => items.mean()),
        max: Array.from(new Array(values.length), (x,i) => items.max()),
        min: Array.from(new Array(values.length), (x,i) => items.min()),
        ecartType: Array.from(new Array(values.length), (x,i) => Math.sqrt(items.variance()))
      };
      createPlot(points, name, title);
    }

    function createPlot(data, name, title) {
      Plotly.newPlot(name, [ {
        x: data.x,
        y: data.y,
        mode: 'lines',
        type: 'scatter',
        name: 'Http Response Time'
      }, {
        x: data.x,
        y: data.mean,
        mode: 'lines',
        type: 'scatter',
        name: 'Mean time'
      }, {
        x: data.x,
        y: data.max,
        mode: 'lines',
        type: 'scatter',
        name: 'Max time'
      }, {
        x: data.x,
        y: data.min,
        mode: 'lines',
        type: 'scatter',
        name: 'Min time'
      }, {
        x: data.x,
        y: data.ecartType,
        mode: 'lines',
        type: 'scatter',
        name: 'Ecart type'
      } ], {
        title:title
      });
    }

    function individualPlot(data, name, title, desc) {
      Plotly.newPlot(name, [{
        x: data.ecartTypeReg.x,
        y: data.ecartTypeReg.y,
        mode: 'lines',
        type: 'scatter',
        name: 'Ecart Type linear regression'
      },{
        x: data.meanReg.x,
        y: data.meanReg.y,
        mode: 'lines',
        type: 'scatter',
        name: 'Mean linear regression'
      }, {
        x: data.mean.x,
        y: data.mean.y,
        mode: 'lines',
        type: 'scatter',
        name: 'Mean'
      }, {
        x: data.ecartType.x,
        y: data.ecartType.y,
        mode: 'lines',
        type: 'scatter',
        name: 'Ecart type'
      }], {
        title:title
      });
    }
  </script>

  <body>
    <h3> Please see your console (F12) to see logs of the example </h3>
    <p> If an error appeared with jquery, it's because you did not clone the repository from github, you just installed the package with npm.
      <br/> JQuery is not in the dependencies installed.</p>

    <div id='httpTime'>
      <div id='httpTime1'> </div>
      <div id='httpTime2'> </div>
      <div id='httpTime3'> </div>
      <div id='httpTimeMean1'> </div>
      <div id='httpTimeMean2'> </div>
      <div id='httpTimeMean3'> </div>
    </div>
  </body>

</html>

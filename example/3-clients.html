<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>3 Clients tests</title>
    <script type='text/javascript' src='../node_modules/jquery/dist/jquery.min.js'> </script>
    <script type='text/javascript' src='../build/foglet-ndp.bundle.js' > </script>
  </head>

  <script type='text/javascript'>
    localStorage.debug = 'foglet-*,HttpClient';

    const NDP = require('foglet-ndp').NDP;
    let endpoint = 'https://query.wikidata.org/bigdata/ldf';
    //endpoint = 'http://172.16.9.3:6000/dbpedia_3_8';
    //endpoint = 'http://curiosiphi.lina.sciences.univ-nantes.prive/dbpedia_3_8';
    //endpoint = 'http://fragments.dbpedia.org/';
    //endpoint = 'http://52.39.116.115/watDiv_100';
    let request = [
      'PREFIX wd: <http://www.wikidata.org/entity/> SELECT * WHERE { ?s ?p wd:Q142. ?s ?p ?o . } LIMIT 10',
  		'PREFIX wd: <http://www.wikidata.org/entity/> SELECT * WHERE { ?s ?p wd:Q142. ?s ?p ?o . } LIMIT 10',
    	'PREFIX wd: <http://www.wikidata.org/entity/> SELECT * WHERE { ?s ?p wd:Q142. ?s ?p ?o . } OFFSET 10 LIMIT 10',
    	'PREFIX wd: <http://www.wikidata.org/entity/> SELECT * WHERE { ?s ?p wd:Q142. ?s ?p ?o . } OFFSET 20 LIMIT 10',
    	'PREFIX wd: <http://www.wikidata.org/entity/> SELECT * WHERE { ?s ?p wd:Q142. ?s ?p ?o . } OFFSET 30 LIMIT 10',
    	'PREFIX wd: <http://www.wikidata.org/entity/> SELECT * WHERE { ?s ?p wd:Q142. ?s ?p ?o . } OFFSET 40 LIMIT 10',
    	'PREFIX wd: <http://www.wikidata.org/entity/> SELECT * WHERE { ?s ?p wd:Q142. ?s ?p ?o . } OFFSET 50 LIMIT 10',
    	'PREFIX wd: <http://www.wikidata.org/entity/> SELECT * WHERE { ?s ?p wd:Q142. ?s ?p ?o . } OFFSET 60 LIMIT 10',
    	'PREFIX wd: <http://www.wikidata.org/entity/> SELECT * WHERE { ?s ?p wd:Q142. ?s ?p ?o . } OFFSET 70 LIMIT 10',
    	'PREFIX wd: <http://www.wikidata.org/entity/> SELECT * WHERE { ?s ?p wd:Q142. ?s ?p ?o . } OFFSET 80 LIMIT 10',
    	'PREFIX wd: <http://www.wikidata.org/entity/> SELECT * WHERE { ?s ?p wd:Q142. ?s ?p ?o . } OFFSET 90 LIMIT 10'
    ];



    let f1,f2,f3;

    let options = {
      verbose: true, // want some logs ? switch to false otherwise
      rps: {
        type: 'spray-wrtc',
        options: {
          protocol: 'ladda-estimator-test', // foglet running on the protocol foglet-example, defined for spray-wrtc
          webrtc:	{ // add WebRTC options
            trickle: true, // enable trickle (divide offers in multiple small offers sent by pieces)
            iceServers : [] // define iceServers in non local instance
          },
          timeout: 2 * 60 * 1000, // spray-wrtc timeout before definitively close a WebRTC connection.
          delta: 2* 60 * 1000, // spray-wrtc shuffle interval
          signaling: {
            address: 'https://signaling.herokuapp.com/',
            // signalingAdress: 'https://signaling.herokuapp.com/', // address of the signaling server
            room: 'ladda-estimator-test' // room to join
          }
        }
      }
    };

    let verbose = true;

    f1 = new NDP(options);
    f2 = new NDP(options);
    f3 = new NDP(options);

    // initialized signaling sharing
    f1.share();
    f2.share();
    f3.share();
    // init each system delegated protocol
    f1.init();
    f2.init();
    f3.init();

    f3.delegationProtocol.timeout = 10*1000;
    f3.delegationProtocol.nbDestinations.value = 0;
    // connection of each peer
    f1.connection(f2).then(() => {
      f2.connection(f3).then(() => {
        f3.connection(f1).then( () => {
          console.log('All clients connected between them.')
          let a = 0, i = 0;
          let list = [];
          for(i = 0; i<1; ++i) list.push(i);

          list.reduce(elem => elem.then((results) => {
            a++;
            console.log('Results: '+a, results);
            return f3.delegationProtocol.sendPromise(request, endpoint, true);
          }), Promise.resolve(undefined));
        }).catch(e => console.log('F3->F1:', e));
      }).catch(e => console.log('F2->F3:',e));
    }).catch(e => console.log('F1->F2:',e));

    // listening on message
    f1.onUnicast((id, message) => console.log);
    f2.onUnicast((id, message) => console.log);
    f3.onUnicast((id, message) => console.log);
  </script>

  <body>
    <h3> Please see your console (F12) to see logs of the example </h3>
    <p> If an error appeared with jquery, it's because you did not clone the repository from github, you just installed the package with npm.
      <br/> JQuery is not in the dependencies installed.</p>
  </body>

</html>
